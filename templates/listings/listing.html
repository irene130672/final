{% extends "base.html" %}
{% load static %}
<!--load humanize -->
{% load humanize %}
{% block title %}
  | {{ listing.title }}
{% endblock title %}
<!-- About main content -->
{% block content %}
  <!-- Success message alert -->
  {% include "partials/_alert.html" %}
  <div class="card"
       style="width: 100%;
              min-height: 100vh;
              background: url('{% static "img/listingspicture.png" %}') no-repeat center center;
              background-size: cover;
              background-color: #ffffff9e;
              display: flex;
              justify-content: center;
              align-items: center;
              padding: 20px;
              box-sizing: border-box">
    <div class="card-header"
         style="width: 100%;
                max-width: 800px;
                background-color: #e8f9fc00;
                padding: 30px;
                margin-right: 100px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0);
                position: relative;
                z-index: 10">
      {% if listing.company.logo %}
        <div style=" margin-bottom: 20px;">
          <img class="card-img-top"
               src="{{ listing.company.logo.url }}"
               alt="Company Logo"
               style="width: 200px;
                      height: 200px;
                      object-fit: contain;
                      margin: 0 auto">
          <br />
          <a href="{% url 'companies:company' listing.company.id %}"
             style="color: #212529;
                    font-size: 25px">{{ listing.company }}</a>
        </h1>
      </div>
    {% endif %}
    <h2>{{ listing.title }}</h2>
    <h1 style="font-size: 25px; margin-bottom: 15px; color: #141414;"></h1>
    <h4 style="font-size: 20px; margin: 8px 0;">
      <p class="mb-0">Budget: {{ listing.budget }}</p>
    </h4>
    <h4 style="font-size: 20px; margin: 8px 0;">
      <p>Duration: {{ listing.duration }}</p>
    </h4>
  </div>
  <div class="card-body"
       style="width: 100%;
              max-width: 800px;
              background-color: #e8f9fc00;
              padding: 30px;
              margin-right: 100px;
              border-radius: 12px;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0);
              position: relative;
              z-index: 10">
    <h3 style="font-size: 22px; margin: 15px 0 8px 0;">
      <strong>Description:</strong>
    </h3>
    <h3 style="font-size: 20px;
               line-height: 1.6;
               color: #141414;
               margin-bottom: 15px">
      <p>{{ listing.description }}</p>
    </h3>
    <h3 style="font-size: 22px; margin: 15px 0 8px 0;">
      <strong>Requirement:</strong>
    </h3>
    <h3 style="font-size: 20px;
               line-height: 1.6;
               color: #141414;
               margin-bottom: 15px">
      <p>{{ listing.requirement }}</p>
    </h3>
    <hr>
    {% if is_own_company_listing %}
      <h4 style="font-size: 20px; color: #141414; margin: 10px 0 20px 0;">
        <p>Published {{ listing.publish_date|timesince }} ago</p>
        <div class="text-center">
          <button type="button"
                  class="btn btn-warning btn-lg px-5"
                  style="background-color: rgb(17, 41, 79);
                         color:white;
                         border:white"
                  data-toggle="modal"
                  data-target="#editJobModal">
            <i class="fas fa-edit me-2"></i>Edit Job
          </button>
          <p class="text-muted mt-2">
            <small>You can edit this job listing</small>
          </p>
        </div>
      {% else %}
        {% if is_company_hr %}
          <!-- Company HR viewing other company's listing - Apply disabled -->
          <div class="text-center">
            <button type="button"
                    class="btn btn-outline-secondary btn-lg px-5 disabled"
                    title="Apply function is only available for individual users">
              <i class="fas fa-ban me-2"></i>HR Cannot Apply
            </button>
            <p class="text-muted mt-2">
              <small>Company HR accounts cannot apply for jobs</small>
            </p>
          </div>
        {% else %}
          <!-- Individual users -->
          {% if user.is_authenticated %}
            {% if has_applied %}
              <!-- User has already applied - Show Edit Application and Withdraw buttons -->
              <div class="application-status-card p-3 mb-4 border rounded bg-light">
                <div class="d-flex align-items-center mb-2">
                  <i class="fas fa-check-circle text-success fa-lg me-2"></i>
                  <h5 class="mb-0">Application Submitted</h5>
                  <!-- Job Status Badge for Applicant -->
                  <div class="ml-2">
                    {% if listing.is_active %}
                      <span class="badge badge-success p-2">
                        <i class="fas fa-check-circle me-1"></i> Active Job
                      </span>
                    {% else %}
                      <span class="badge badge-secondary p-2">
                        <i class="fas fa-times-circle me-1"></i> Inactive Job
                      </span>
                    {% endif %}
                  </div>
                </div>
                <div class="mb-3">
                  <!-- Warning for inactive jobs -->
                  {% if not listing.is_active %}
                    <div class="alert alert-warning p-2 mb-3">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                          <strong class="d-block">Job is Inactive</strong>
                          <small class="d-block">This job is no longer active. Your application may not be considered by the company.</small>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                  <p class="mb-1">
                    <i class="fas fa-calendar-alt text-muted me-1"></i>
                    <strong>Applied on:</strong>
                    <span class="text-primary">{{ existing_application.apply_date|date:"F j, Y" }}</span>
                    at
                    <span class="text-primary">{{ existing_application.apply_date|time:"g:i A" }}</span>
                  </p>
                  <p class="text-muted mb-0">
                    <small>
                      <i class="fas fa-info-circle me-1"></i>
                      You can edit your application or withdraw it below.
                    </small>
                  </p>
                </div>
                <!-- Action Buttons -->
                <div class="d-flex flex-wrap gap-3 justify-content-center">
                  <a href="{% url 'applies:apply' listing.id %}"
                     class="btn btn-primary btn-lg px-4"
                     title="Edit your existing application">
                    <i class="fas fa-edit me-2"></i>Edit Application
                  </a>
                  <button type="button"
                          class="btn btn-outline-danger btn-lg px-4 ml-3"
                          onclick="confirmWithdraw('{% url 'applies:withdraw' listing.id %}')"
                          title="Withdraw your application">
                    <i class="fas fa-trash-alt me-2"></i>Withdraw
                  </button>
                </div>
              </div>
            {% else %}
              <!-- User hasn't applied yet - Show Apply button -->
              <div class="text-center">
                <a href="{% url 'applies:apply' listing.id %}"
                   class="btn btn-primary btn-lg px-5">
                  <i class="fas fa-paper-plane me-2"></i>Apply Now
                </a>
                <p class="text-muted mt-2">
                  <small>Click to submit your application for this position</small>
                </p>
              </div>
            {% endif %}
          {% else %}
            <!-- Not logged in -->
            <div class="text-center">
              <a href="{% url 'accounts:login' %}?next={{ request.path }}"
                 class="btn btn-outline-primary btn-lg px-5"
                 title="Please login to apply for jobs">
                <i class="fas fa-sign-in-alt me-2"></i>Login to Apply
              </a>
              <p class="text-muted mt-2">
                <small>You need to be logged in to apply for this job</small>
              </p>
            </div>
          {% endif %}
        {% endif %}
      {% endif %}
    </div>
  </div>
  <!-- Edit Job Modal -->
  <div class="modal fade"
       id="editJobModal"
       tabindex="-1"
       role="dialog"
       aria-labelledby="editJobModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editJobModalLabel">Edit Job: {{ listing.title }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Warning for inactive jobs -->
          {% if not listing.is_active %}
            <div class="alert alert-warning mb-4">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                <div>
                  <h5 class="alert-heading mb-1">Inactive Job Warning</h5>
                  <p class="mb-0">
                    {% if is_own_company_listing %}
                      This job is inactive. Any changes you make will not be visible to applicants until the job is reactivated.
                    {% elif has_applied %}
                      This job is inactive. Any adjustments to your application may not be considered by the employer.
                    {% endif %}
                  </p>
                </div>
              </div>
            </div>
          {% endif %}
          <form id="editJobForm" method="POST" action="">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ listing.id }}" />
            <div class="form-group">
              <label for="editTitle">Job Title</label>
              <input type="text"
                     class="form-control"
                     id="editTitle"
                     name="title"
                     value="{{ listing.title }}"
                     required />
            </div>
            <div class="form-group">
              <label for="editIndustry">Industry</label>
              <select class="form-control" id="editIndustry" name="industry" required>
                <option value="" disabled>Select Industry</option>
                {% for key, value in industry_choices.items %}
                  <option value="{{ key }}" {% if listing.industry == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="editBudget">Budget</label>
              <select class="form-control" id="editBudget" name="budget" required>
                <option value="" disabled>Select Budget</option>
                {% for key, value in budget_choices.items %}
                  <option value="{{ key }}" {% if listing.budget == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="editDuration">Duration</label>
              <select class="form-control" id="editDuration" name="duration" required>
                <option value="" disabled>Select Duration</option>
                {% for key, value in duration_choices.items %}
                  <option value="{{ key }}" {% if listing.duration == key %}selected{% endif %}>{{ value }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group">
              <label for="editRequirement">Requirement</label>
              <textarea class="form-control"
                        id="editRequirement"
                        name="requirement"
                        rows="3"
                        required>{{listing.requirement}}</textarea>
            </div>
            <div class="form-group">
              <label for="editDescription">Description</label>
              <textarea class="form-control"
                        id="editDescription"
                        name="description"
                        rows="5"
                        required>{{listing.description}}</textarea>
            </div>
            <!-- Job Status Toggle (only for HR who posted the job) -->
            {% if is_own_company_listing %}
              <div class="form-group">
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         id="editIsActive"
                         name="is_active"
                         {% if listing.is_active %}checked{% endif %}>
                  <label class="form-check-label" for="editIsActive">
                    <strong>Job is Active</strong>
                  </label>
                  <small class="form-text text-muted">
                    Uncheck to make this job inactive. Inactive jobs are only visible to you and applicants.
                  </small>
                </div>
              </div>
            {% endif %}
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
          <button type="submit" form="editJobForm" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>
  </div>
  <script>
  function confirmWithdraw(url) {
    if (confirm('Are you sure you want to withdraw your application?\n\nThis action cannot be undone. You will need to apply again if you change your mind.')) {
      // Create a form to submit the withdrawal request
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = url;
      
      // Add CSRF token
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const csrfInput = document.createElement('input');
      csrfInput.type = 'hidden';
      csrfInput.name = 'csrfmiddlewaretoken';
      csrfInput.value = csrfToken;
      form.appendChild(csrfInput);
      
      // Submit the form
      document.body.appendChild(form);
      form.submit();
    }
  }
  
  // Show warning when individual user edits application for inactive job
  document.addEventListener('DOMContentLoaded', function() {
    // Check if this is an individual user who has applied
    const applicationCard = document.querySelector('.application-status-card');
    if (applicationCard) {
      // Check if job is inactive by looking for the inactive badge
      const inactiveBadge = applicationCard.querySelector('.badge.badge-secondary');
      if (inactiveBadge && inactiveBadge.textContent.includes('Inactive Job')) {
        // Find the Edit Application button
        const editApplicationBtn = applicationCard.querySelector('a[href*="apply"]');
        if (editApplicationBtn) {
          editApplicationBtn.addEventListener('click', function(e) {
            if (!confirm('⚠️ JOB IS INACTIVE ⚠️\n\nThis job is no longer active.\\n\\nYour application may not be considered by the company.\\n\\nDo you still want to edit your application?')) {
              e.preventDefault();
            }
          });
        }
      }
    }
  });
  </script>
{% endblock content %}
